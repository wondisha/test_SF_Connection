--MONITOR SNOWFLAKE --
SET MONITOR_DATABASE ='MONITOR';
SET MONITOR_REFERENCE_SCHEMA ='MONITOR.REFERENCE_OWNER';
SET MONITOR_OWNER_SCHEMA = 'MONITOR.MONITOR_OWNER';
SET MONITOR_WAREHOUSE ='MONITOR_WH';
SET MONITOR_REFERENCE_ROLE ='MONITOR_REFERENCE_ROLE';
SET MONITOR_READER_ROLE ='MONITOR_OWNER_ROLE';
SET MONITOR_OWNER_ROLE ='MONITOR_READER_ROLE';

--CREATE DB--
USE ROLE SYSADMIN;

CREATE OR REPLACE DATABASE IDENTIFIER($MONITOR_DATABASE) DATA_RETENTION_TIME_IN_DAYS =90;
CREATE OR REPLACE WAREHOUSE IDENTIFIER($MONITOR_warehouse) WITH 
WAREHOUSE_SIZE     ='X-SMALL'
AUTO_SUSPEND       = 60
AUTO_RESUME        = TRUE
MIN_CLUSTER_COUNT  = 1
MAX_CLUSTER_COUNT   =4
SCALING_POLICY      ='STANDARD'
INITIALLY_SUSPENDED  =TRUE;

CREATE OR REPLACE SCHEMA IDENTIFIER ($MONITOR_REFERENCE_SCHEMA);
CREATE OR REPLACE SCHEMA IDENTIFIER ($MONITOR_OWNER_SCHEMA);

--CREATE ROLE--
USE ROLE SECURITYADMIN;
CREATE OR REPLACE ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE) COMMENT = 'MONITOR.MONITOR_REFERENCE ROLE';
CREATE OR REPLACE ROLE IDENTIFIER ($MONITOR_OWNER_ROLE) COMMENT = 'MONITOR.MONITOR_OWNER ROLE';
CREATE OR REPLACE ROLE IDENTIFIER ($MONITOR_READER_ROLE) COMMENT ='MONITOR.MONITOR_READER ROLE';

--assign roles to security admin

grant role identifier ($monitor_reference_role) to role securityadmin;
grant role identifier ($MONITOR_OWNER_ROLE) to role securityadmin;
grant role identifier ($MONITOR_READER_ROLE) to role securityadmin;

--ENABLE EACH ROLE TO USE THE DATABASE AND WAREHOUSE--

GRANT USAGE ON DATABASE IDENTIFIER ($MONITOR_DATABASE) TO ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE);
GRANT USAGE ON WAREHOUSE IDENTIFIER ($MONITOR_WAREHOUSE) TO ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE);
GRANT OPERATE ON WAREHOUSE IDENTIFIER ($MONITOR_WAREHOUSE) TO ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE);
GRANT USAGE ON SCHEMA IDENTIFIER ($MONITOR_REFERENCE_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE);
GRANT USAGE ON DATABASE IDENTIFIER ($MONITOR_DATABASE) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
GRANT USAGE ON WAREHOUSE IDENTIFIER ($MONITOR_WAREHOUSE) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
GRANT OPERATE ON WAREHOUSE IDENTIFIER ($MONITOR_WAREHOUSE) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
GRANT USAGE ON SCHEMA IDENTIFIER ($MONITOR_REFERENCE_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
GRANT USAGE ON SCHEMA IDENTIFIER ($MONITOR_OWNER_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
GRANT USAGE ON DATABASE IDENTIFIER ($MONITOR_DATABASE) TO ROLE IDENTIFIER ($MONITOR_READER_ROLE);
GRANT USAGE ON WAREHOUSE IDENTIFIER ($MONITOR_WAREHOUSE) TO ROLE IDENTIFIER ($MONITOR_READER_ROLE);
GRANT OPERATE ON WAREHOUSE IDENTIFIER ($MONITOR_WAREHOUSE) TO ROLE IDENTIFIER ($MONITOR_READER_ROLE);
GRANT USAGE ON SCHEMA IDENTIFIER ($MONITOR_REFERENCE_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_READER_ROLE);

--GRANT SPECIFIC OBJECT ENTITLEMENTS

GRANT CREATE TABLE ON SCHEMA IDENTIFIER ($MONITOR_REFERENCE_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE);
GRANT CREATE VIEW ON SCHEMA IDENTIFIER($MONITOR_REFERENCE_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE);
GRANT CREATE SEQUENCE ON SCHEMA IDENTIFIER($MONITOR_REFERENCE_SCHEMA)TO ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE);
GRANT CREATE STREAM ON SCHEMA IDENTIFIER($MONITOR_REFERENCE_SCHEMA)TO ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE);
GRANT CREATE MATERIALIZED VIEW ON SCHEMA IDENTIFIER($MONITOR_REFERENCE_SCHEMA)TO ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE);
GRANT CREATE VIEW ON SCHEMA IDENTIFIER ($MONITOR_OWNER_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
GRANT CREATE SEQUENCE ON SCHEMA IDENTIFIER ($MONITOR_OWNER_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
GRANT CREATE FUNCTION ON SCHEMA IDENTIFIER ($MONITOR_OWNER_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
GRANT CREATE PROCEDURE ON SCHEMA IDENTIFIER ($MONITOR_OWNER_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
GRANT CREATE MATERIALIZED VIEW ON SCHEMA IDENTIFIER ($MONITOR_OWNER_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
GRANT CREATE FILE FORMAT ON SCHEMA IDENTIFIER ($MONITOR_OWNER_SCHEMA) TO ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);

--assign roles to user
GRANT ROLE IDENTIFIER ($MONITOR_REFERENCE_ROLE) TO USER WONDISHA;
GRANT ROLE IDENTIFIER($MONITOR_OWNER_ROLE) TO USER WONDISHA;
GRANT ROLE IDENTIFIER ($MONITOR_READER_ROLE) TO USER WONDISHA;

--ENABLE ACCOUNT USAGE STORE--

GRANT IMPORTED PRIVILEGES ON DATABASE SNOWFLAKE TO ROLE IDENTIFIER($MONITOR_OWNER_ROLE);


--MONITOR_OWNER_ROLE THE ONLY ONE TO VIEW ACCOUNT USAGE STORAGE
USE ROLE IDENTIFIER ($MONITOR_OWNER_ROLE);
USE DATABASE IDENTIFIER($MONITOR_DATABASE);
USE SCHEMA IDENTIFIER ($MONITOR_OWNER_SCHEMA);
USE WAREHOUSE IDENTIFIER($MONITOR_WAREHOUSE);
--QUERY ACCOUNT USAGE--
SELECT *
FROM SNOWFLAKE.ACCOUNT_USAGE.DATABASES
WHERE DELETED IS NULL;